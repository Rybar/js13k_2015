G.ALL=[],G["const"]={GRID:32,WIDTH:25,HEIGHT:18,P_SPEED:.03,P_FRICTX:.92,P_FRICTY:.94,P_GRAVITY:.02,P_JUMP:.5},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();var sonantx;!function(){"use strict";function osc_sin(value){return Math.sin(6.283184*value)}function osc_square(value){return osc_sin(value)<0?-1:1}function osc_saw(value){return value%1-.5}function osc_tri(value){var v2=value%1*4;return 2>v2?v2-1:3-v2}function getnotefreq(n){return.00390625*Math.pow(1.059463094,n-128)}function genBuffer(waveSize,callBack){setTimeout(function(){var buf=new Uint8Array(waveSize*WAVE_CHAN*2),b=buf.length-2,iterate=function(){for(var begin=new Date,count=0;b>=0;)if(buf[b]=0,buf[b+1]=128,b-=2,count+=1,count%1e3===0&&new Date-begin>MAX_TIME)return void setTimeout(iterate,0);setTimeout(function(){callBack(buf)},0)};setTimeout(iterate,0)},0)}function applyDelay(chnBuf,waveSamples,instr,rowLen,callBack){var p1=instr.fx_delay_time*rowLen>>1,t1=instr.fx_delay_amt/255,n1=0,iterate=function(){for(var beginning=new Date,count=0;waveSamples-p1>n1;){var b1=4*n1,l=4*(n1+p1),x1=chnBuf[l]+(chnBuf[l+1]<<8)+(chnBuf[b1+2]+(chnBuf[b1+3]<<8)-32768)*t1;if(chnBuf[l]=255&x1,chnBuf[l+1]=x1>>8&255,x1=chnBuf[l+2]+(chnBuf[l+3]<<8)+(chnBuf[b1]+(chnBuf[b1+1]<<8)-32768)*t1,chnBuf[l+2]=255&x1,chnBuf[l+3]=x1>>8&255,++n1,count+=1,count%1e3===0&&new Date-beginning>MAX_TIME)return void setTimeout(iterate,0)}setTimeout(callBack,0)};setTimeout(iterate,0)}sonantx={};var WAVE_SPS=44100,WAVE_CHAN=2,MAX_TIME=33,audioCtx=null,oscillators=[osc_sin,osc_square,osc_saw,osc_tri];sonantx.AudioGenerator=function(mixBuf){this.mixBuf=mixBuf,this.waveSize=mixBuf.length/WAVE_CHAN/2},sonantx.AudioGenerator.prototype.getWave=function(){var b,k,x,wave,l1,l2,y,mixBuf=this.mixBuf,waveSize=this.waveSize,waveBytes=waveSize*WAVE_CHAN*2;for(l1=waveBytes-8,l2=l1-36,wave=String.fromCharCode(82,73,70,70,255&l1,l1>>8&255,l1>>16&255,l1>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&l2,l2>>8&255,l2>>16&255,l2>>24&255),b=0;waveBytes>b;){for(x="",k=0;256>k&&waveBytes>b;++k,b+=2)y=4*(mixBuf[b]+(mixBuf[b+1]<<8)-32768),y=-32768>y?-32768:y>32767?32767:y,x+=String.fromCharCode(255&y,y>>8&255);wave+=x}return wave},sonantx.AudioGenerator.prototype.getAudio=function(){var wave=this.getWave(),a=new Audio("data:audio/wav;base64,"+btoa(wave));return a.preload="none",a.load(),a},sonantx.AudioGenerator.prototype.getAudioBuffer=function(callBack){null===audioCtx&&(audioCtx=new AudioContext);var mixBuf=this.mixBuf,waveSize=this.waveSize,waveBytes=waveSize*WAVE_CHAN*2,buffer=audioCtx.createBuffer(WAVE_CHAN,this.waveSize,WAVE_SPS),lchan=buffer.getChannelData(0),rchan=buffer.getChannelData(1),b=0,iterate=function(){for(var beginning=new Date,count=0;waveBytes/2>b;){var y=4*(mixBuf[4*b]+(mixBuf[4*b+1]<<8)-32768);if(y=-32768>y?-32768:y>32767?32767:y,lchan[b]=y/32768,y=4*(mixBuf[4*b+2]+(mixBuf[4*b+3]<<8)-32768),y=-32768>y?-32768:y>32767?32767:y,rchan[b]=y/32768,b+=1,count+=1,count%1e3===0&&new Date-beginning>MAX_TIME)return void setTimeout(iterate,0)}setTimeout(function(){callBack(buffer)},0)};setTimeout(iterate,0)},sonantx.SoundGenerator=function(instr,rowLen){this.instr=instr,this.rowLen=rowLen||5605,this.osc_lfo=oscillators[instr.lfo_waveform],this.osc1=oscillators[instr.osc1_waveform],this.osc2=oscillators[instr.osc2_waveform],this.attack=instr.env_attack,this.sustain=instr.env_sustain,this.release=instr.env_release,this.panFreq=Math.pow(2,instr.fx_pan_freq-8)/this.rowLen,this.lfoFreq=Math.pow(2,instr.lfo_freq-8)/this.rowLen},sonantx.SoundGenerator.prototype.genSound=function(n,chnBuf,currentpos){for(var c1=(new Date,0),c2=0,o1t=getnotefreq(n+12*(this.instr.osc1_oct-8)+this.instr.osc1_det)*(1+8e-4*this.instr.osc1_detune),o2t=getnotefreq(n+12*(this.instr.osc2_oct-8)+this.instr.osc2_det)*(1+8e-4*this.instr.osc2_detune),q=this.instr.fx_resonance/255,low=0,band=0,j=this.attack+this.sustain+this.release-1;j>=0;--j){var k=j+currentpos,lfor=this.osc_lfo(k*this.lfoFreq)*this.instr.lfo_amt/512+.5,e=1;j<this.attack?e=j/this.attack:j>=this.attack+this.sustain&&(e-=(j-this.attack-this.sustain)/this.release);var t=o1t;this.instr.lfo_osc1_freq&&(t+=lfor),this.instr.osc1_xenv&&(t*=e*e),c1+=t;var rsample=this.osc1(c1)*this.instr.osc1_vol;t=o2t,this.instr.osc2_xenv&&(t*=e*e),c2+=t,rsample+=this.osc2(c2)*this.instr.osc2_vol,this.instr.noise_fader&&(rsample+=(2*Math.random()-1)*this.instr.noise_fader*e),rsample*=e/255;var f=this.instr.fx_freq;this.instr.lfo_fx_freq&&(f*=lfor),f=1.5*Math.sin(3.141592*f/WAVE_SPS),low+=f*band;var high=q*(rsample-band)-low;switch(band+=f*high,this.instr.fx_filter){case 1:rsample=high;break;case 2:rsample=low;break;case 3:rsample=band;break;case 4:rsample=low+high}if(t=osc_sin(k*this.panFreq)*this.instr.fx_pan_amt/512+.5,rsample*=39*this.instr.env_master,k=4*k,k+3<chnBuf.length){var x=chnBuf[k]+(chnBuf[k+1]<<8)+rsample*(1-t);chnBuf[k]=255&x,chnBuf[k+1]=x>>8&255,x=chnBuf[k+2]+(chnBuf[k+3]<<8)+rsample*t,chnBuf[k+2]=255&x,chnBuf[k+3]=x>>8&255}}},sonantx.SoundGenerator.prototype.getAudioGenerator=function(n,callBack){var bufferSize=this.attack+this.sustain+this.release-1+32*this.rowLen,self=this;genBuffer(bufferSize,function(buffer){self.genSound(n,buffer,0),applyDelay(buffer,bufferSize,self.instr,self.rowLen,function(){callBack(new sonantx.AudioGenerator(buffer))})})},sonantx.SoundGenerator.prototype.createAudio=function(n,callBack){this.getAudioGenerator(n,function(ag){callBack(ag.getAudio())})},sonantx.SoundGenerator.prototype.createAudioBuffer=function(n,callBack){this.getAudioGenerator(n,function(ag){ag.getAudioBuffer(callBack)})},sonantx.MusicGenerator=function(song){this.song=song,this.waveSize=WAVE_SPS*song.songLen},sonantx.MusicGenerator.prototype.generateTrack=function(instr,mixBuf,callBack){var self=this;genBuffer(this.waveSize,function(chnBuf){var waveSamples=self.waveSize,waveBytes=self.waveSize*WAVE_CHAN*2,rowLen=self.song.rowLen,endPattern=self.song.endPattern,soundGen=new sonantx.SoundGenerator(instr,rowLen),currentpos=0,p=0,row=0,recordSounds=function(){for(var beginning=new Date;;)if(32!==row){if(p===endPattern-1)return void setTimeout(delay,0);var cp=instr.p[p];if(cp){var n=instr.c[cp-1].n[row];n&&soundGen.genSound(n,chnBuf,currentpos)}if(currentpos+=rowLen,row+=1,new Date-beginning>MAX_TIME)return void setTimeout(recordSounds,0)}else row=0,p+=1},delay=function(){applyDelay(chnBuf,waveSamples,instr,rowLen,finalize)},b2=0,finalize=function(){for(var beginning=new Date,count=0;waveBytes>b2;){var x2=mixBuf[b2]+(mixBuf[b2+1]<<8)+chnBuf[b2]+(chnBuf[b2+1]<<8)-32768;if(mixBuf[b2]=255&x2,mixBuf[b2+1]=x2>>8&255,b2+=2,count+=1,count%1e3===0&&new Date-beginning>MAX_TIME)return void setTimeout(finalize,0)}setTimeout(callBack,0)};setTimeout(recordSounds,0)})},sonantx.MusicGenerator.prototype.getAudioGenerator=function(callBack){var self=this;genBuffer(this.waveSize,function(mixBuf){var t=0,recu=function(){t<self.song.songData.length?(t+=1,self.generateTrack(self.song.songData[t-1],mixBuf,recu)):callBack(new sonantx.AudioGenerator(mixBuf))};recu()})},sonantx.MusicGenerator.prototype.createAudio=function(callBack){this.getAudioGenerator(function(ag){callBack(ag.getAudio())})},sonantx.MusicGenerator.prototype.createAudioBuffer=function(callBack){this.getAudioGenerator(function(ag){ag.getAudioBuffer(callBack)})}}(),G.sonantx=sonantx,G.Key={_pressed:{},LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,z:90,isDown:function(keyCode){return this._pressed[keyCode]},onKeydown:function(event){this._pressed[event.keyCode]=!0},onKeyup:function(event){delete this._pressed[event.keyCode]}},G.map=[[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1]],G.Entity=function(){this.cx=0,this.cy=0,this.xr=0,this.yr=0,this.xx=0,this.yy=0,this.dx=0,this.dy=0,this.radius=0,this.gravity=0},G.Entity.prototype.setCoords=function(x,y){this.xx=x,this.yy=y,this.cx=Math.floor(this.xx/G["const"].GRID),this.cy=Math.floor(this.yy/G["const"].GRID),this.xr=(this.xx-this.cx*G["const"].GRID)/G["const"].GRID,this.xy=(this.yy-this.cy*G["const"].GRID)/G["const"].GRID},G.Entity.prototype.hasCollision=function(cx,cy){return this.cx<0||cx>=G["const"].WIDTH?!0:void 0==G.map[cy]?!1:G.map[cy][cx]},G.Entity.prototype.overlaps=function(e){var maxDist=this.radius+e.radius,distSqr=(e.xx-this.xx)*(e.xx-this.xx)+(e.yy-this.yy)*(e.yy-this.yy);return maxDist*maxDist>=distSqr?!0:!1},G.Entity.prototype.onGround=function(){return this.hasCollision(this.cx,this.cy+1)&&this.yr>=.5},G.Entity.prototype.update=function(){var frictX=.92,frictY=.94,gravity=this.gravity;for(this.xr+=this.dx,this.dx*=frictX,this.hasCollision(this.cx-1,this.cy)&&this.xr<=.3&&(this.dx=0,this.xr=.9),this.hasCollision(this.cx+1,this.cy)&&this.xr>=.7&&(this.dx=0,this.xr=.3);this.xr<0;)this.cx--,this.xr++;for(;this.xr>1;)this.cx++,this.xr--;for(this.dy+=gravity,this.yr+=this.dy,this.dy*=frictY,this.hasCollision(this.cx,this.cy-1)&&this.yr<=.4&&(this.dy=0,this.yr=.4),this.hasCollision(this.cx,this.cy+1)&&this.yr>=.6&&(this.dy=0,this.yr=.6);this.yr<0;)this.cy--,this.yr++;for(;this.yr>1;)this.cy++,this.yr--;for(var i=0;i<G.ALL.length;i++){var e=G.ALL[i];if(e!=this&&Math.abs(this.cx-e.cx)<=1&&Math.abs(this.cy-e.cy)<=1){var dist=Math.sqrt((e.xx-this.xx)*(e.xx-this.xx)+(e.yy-this.yy)*(e.yy-this.yy));if(dist<=this.radius+e.radius){var ang=Math.atan2(e.yy-this.yy,e.xx-this.xx),force=.03,repelPower=(this.radius+e.radius-dist)/(this.radius+e.radius);this.dx-=Math.cos(ang)*repelPower*force,this.dy-=Math.sin(ang)*repelPower*force,e.dx+=Math.cos(ang)*repelPower*force,e.dy+=Math.sin(ang)*repelPower*force}}}this.xx=Math.floor((this.cx+this.xr)*G["const"].GRID),this.yy=Math.floor((this.cy+this.yr)*G["const"].GRID),this.yy>G["const"].GRID*G["const"].HEIGHT+this.radius&&this.setCoords(this.xx,-this.radius)},G.player=new G.Entity,G.player.width=32,G.player.height=32,G.player.radius=16,G.player.gravity=G["const"].P_GRAVITY,G.player.setCoords(400,100),G.player.draw=function(ctx){G.player;ctx.beginPath(),ctx.arc(this.xx,this.yy,this.radius,0,2*Math.PI,!1),ctx.fillStyle="red",ctx.fill()},G.player.moveLeft=function(){this.dx-=G["const"].P_SPEED},G.player.moveRight=function(){this.dx+=G["const"].P_SPEED},G.player.moveUp=function(){this.dy=-G["const"].P_JUMP},G.player.moveDown=function(){this.dy+=G["const"].P_SPEED},G.player.inputUpdate=function(){G.Key.isDown(G.Key.UP)&&this.moveUp(),G.Key.isDown(G.Key.SPACE)&&this.moveUp(),G.Key.isDown(G.Key.z)&&this.moveUp(),G.Key.isDown(G.Key.DOWN)&&this.moveDown(),G.Key.isDown(G.Key.LEFT)&&this.moveLeft(),G.Key.isDown(G.Key.RIGHT)&&this.moveRight(),this.yy>G["const"].GRID*G["const"].HEIGHT+this.radius&&this.setCoords(this.xx,-this.radius)},G.mobs=[],G.makeMobs=function(){for(var i=0;300>=i;i++){var mob=new G.Entity;mob.radius=8,mob.width=16,mob.height=16,mob.gravity=.02,mob.setCoords(700*Math.random()+32,100*Math.random()),G.mobs.push(mob),G.ALL.push(mob)}}(),G.drawMobs=function(ctx){G.mobs.forEach(function(e){e.update(),ctx.beginPath(),ctx.arc(e.xx+e.radius,e.yy+e.radius,e.radius,0,2*Math.PI,!1),ctx.fillStyle="blue",ctx.fill()})},G.enemy=new G.Entity,G.enemy.setCoords(300,500),G.enemy.width=16,G.enemy.height=16,G.enemy.radius=8,G.enemy.draw=function(ctx){ctx.beginPath(),ctx.arc(this.xx,this.yy,this.radius,0,2*Math.PI,!1),ctx.fillStyle="white",ctx.fill()},G.enemy.eUpdate=function(){},G.canvas=document.querySelector("#game"),G.ctx=G.canvas.getContext("2d"),G.ALL.push(G.player),G.drawMap=function(ctx){for(var i=0;i<G.map.length;i++)for(var j=0;j<G.map[i].length;j++)G.map[i][j]&&(ctx.fillStyle="gray",ctx.fillRect(j*G["const"].GRID,i*G["const"].GRID,G["const"].GRID,G["const"].GRID))},G.loop=function(){requestAnimationFrame(G.loop),G.ctx.fillStyle="rgba(0,0,0,0.4)",G.ctx.fillRect(0,0,800,600),G.player.inputUpdate(),G.player.update(),G.drawMap(G.ctx),G.drawMobs(G.ctx),G.player.draw(G.ctx),G.enemy.draw(G.ctx)},window.addEventListener("keyup",function(event){G.Key.onKeyup(event)},!1),window.addEventListener("keydown",function(event){G.Key.onKeydown(event)},!1),window.onload=G.loop;